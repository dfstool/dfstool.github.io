"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8343,8255],{67576:function(e,t,n){n.r(t);var r=n(15009),o=n.n(r),a=n(99289),s=n.n(a),u=n(5574),i=n.n(u),c=n(19601),l=n(64119),d=n(37476),m=n(5966),f=n(90672),p=n(59530),b=n(45360),x=n(27484),h=n.n(x),v=n(70178),g=n.n(v),S=n(62435),k=n(86074);h().extend(g());var y=S.forwardRef((function(e,t){var n=(0,p.useDispatch)(),r=b.ZP.useMessage(),a=i()(r,2),u=a[0],x=a[1],v=(0,p.useSelector)((function(e){return e.global.session})),g=(0,p.useSelector)((function(e){return e.global.account})),y=(0,p.useSelector)((function(e){return e.global.contractKit})),M=(0,p.useIntl)(),j=M.formatMessage({id:"common.intlInputException"}),F=M.formatMessage({id:"account.intlSearch"}),C=M.formatMessage({id:"contract.intlAccountFormatError"}),w=M.formatMessage({id:"node.intlNode"}),N=M.formatMessage({id:"tools.nodebonus.intlBonusAmount"}),Z=M.formatMessage({id:"tools.nodebonus.intlRequireVote"}),R=M.formatMessage({id:"tools.nodebonus.intlBonusMemo"}),D=(0,S.useRef)(),E=(0,S.useState)(!1),P=i()(E,2),V=P[0],_=P[1],I=(0,S.useMemo)((function(){return g&&g.data.core_liquid_balance?g.data.core_liquid_balance.toString():"0.00000000 DFS"}),[g]),T=(0,S.useCallback)((function(){_(!0)}),[]);(0,S.useImperativeHandle)(t,(function(){return{handleOpen:T}}));var q=(0,S.useCallback)(function(){var e=s()(o()().mark((function e(t,n){var r,a,s;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(/^[a-z1-5.]{1,12}$/.test(t)){e.next=8;break}if(t||n.hasOwnProperty("type")){e.next=4;break}return e.abrupt("return",!1);case 4:return u.error("".concat(C)),e.abrupt("return",!1);case 8:return e.next=10,(0,l.zI)(v.client.v1.chain.get_account(t));case 10:if(r=e.sent,a=i()(r,1),!(s=a[0])){e.next=16;break}return u.error(s),e.abrupt("return",!1);case 16:return e.abrupt("return",!0);case 17:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),[v,u]),z=(0,S.useCallback)(function(){var e=s()(o()().mark((function e(t){var r,a,s,i,d,m,f,p,b,x,v,g;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.node,a=t.bonusAmount,s=t.requireVote,i=t.bonusMemo,e.next=3,q(r,"");case 3:if(e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.prev=5,d=0,m=0,f=0,p=0,b=[],e.next=13,y.load("dfsbpsvoters");case 13:return x=e.sent,v=x.table("vlists",r),e.next=17,v.all();case 17:return(g=e.sent).forEach((function(e){m+=e.vote_power.value/1e8})),g.forEach((function(e,t){var n=e.voter.toString(),r=e.vote_power.value/1e8,o=r/m,u=o*Number(a);r<=Number(s)||(b.push({key:t,voter:n,vote:r,ratio:o,bonus:u,memo:i,voteTime:h().utc(e.vote_time.toString()).local().format("YYYY-MM-DDTHH:mm:ss")}),d+=1,f+=o,p+=u)})),b.sort((function(e,t){return t.vote-e.vote})),n(c.N.setBonusDataSource(b)),n(c.N.setSummary({node:r,totalVoters:d,totalVotes:m,totalRatio:f,totalBonus:p})),e.abrupt("return",!0);case 26:e.prev=26,e.t0=e.catch(5),(0,l.Tv)(e.t0,u);case 29:case"end":return e.stop()}}),e,null,[[5,26]])})));return function(t){return e.apply(this,arguments)}}(),[q]);return(0,k.jsxs)(d.Y,{formRef:D,title:F,open:V,onFinish:z,onOpenChange:function(e){_(e)},layout:"vertical",width:"400px",initialValues:{requireVote:0,memo:""},children:[(0,k.jsx)(m.Z,{name:"node",label:w,placeholder:"",fieldProps:{size:"large",autoFocus:!1},rules:[{required:!0,whitespace:!0,message:"".concat(j),pattern:/^[a-z1-5.]{1,12}$/}]}),(0,k.jsx)(m.Z,{name:"bonusAmount",label:N,placeholder:I,rules:[{required:!0,message:"".concat(j),whitespace:!0,pattern:/^\d+(\.\d{1,8})?$/}],fieldProps:{size:"large",autoFocus:!1}}),(0,k.jsx)(f.Z,{name:"bonusMemo",label:R,placeholder:"",fieldProps:{size:"large",autoFocus:!1,autoSize:{minRows:1}}}),(0,k.jsx)(m.Z,{name:"requireVote",label:Z,placeholder:"",rules:[{required:!0,message:"".concat(j),whitespace:!0,pattern:/^-?\d+(\.\d{1,8})?$/}],fieldProps:{size:"large",autoFocus:!1}}),x]})}));t.default=(0,S.memo)(y)},29088:function(e,t,n){n.r(t),n.d(t,{default:function(){return w}});var r=n(15009),o=n.n(r),a=n(99289),s=n.n(a),u=n(5574),i=n.n(u),c=n(64119),l=n(11774),d=n(92340),m=n(59530),f=n(80507),p=n(45360),b=n(42075),x=n(15867),h=n(62120),v=n(27484),g=n.n(v),S=n(70178),k=n.n(S),y=n(53667),M=n.n(y),j=n(62435),F=n(67576),C=n(86074);g().extend(k());var w=function(){var e=p.ZP.useMessage(),t=i()(e,2),n=t[0],r=t[1],a=(0,m.useSelector)((function(e){return e.global.session})),u=(0,m.useSelector)((function(e){return e.global.account})),v=(0,m.useSelector)((function(e){return e.vote.bonusDataSource})),S=(0,m.useSelector)((function(e){return e.vote.summary})),k=(0,j.useRef)(),y=(0,m.useIntl)(),w=y.formatMessage({id:"vote.intlExportComplete"}),N=y.formatMessage({id:"tools.nodebonus.intlVoter"}),Z=y.formatMessage({id:"tools.nodebonus.intlVote"}),R=y.formatMessage({id:"tools.nodebonus.intlVoteTime"}),D=y.formatMessage({id:"tools.nodebonus.intlVoteRatio"}),E=y.formatMessage({id:"tools.nodebonus.intlSearchNode"}),P=y.formatMessage({id:"tools.nodebonus.intlExecBonus"}),V=y.formatMessage({id:"tools.nodebonus.intlExportData"}),_=y.formatMessage({id:"tools.nodebonus.intlExportAction"}),I=y.formatMessage({id:"tools.nodebonus.intlBonusAmount"}),T=y.formatMessage({id:"tools.nodebonus.intlSummary"}),q=y.formatMessage({id:"common.intlPleaseConnectWallet"}),z=y.formatMessage({id:"common.intlPleaseConnectNetwork"}),B=y.formatMessage({id:"common.intlInsufficientBalance"}),A=y.formatMessage({id:"common.intlTransferSuccess"}),O=y.formatMessage({id:"common.intlTransferFail"}),Y=y.formatMessage({id:"contract.intlExported"}),H=(0,j.useCallback)(s()(o()().mark((function e(){var t,r;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==v.length){e.next=2;break}return e.abrupt("return",!1);case 2:return t=function(e){var t=e.map((function(e,t){return{"#":(t+1).toString(),"投票人":e.voter,"票数":e.vote.toString(),"投票占比":(100*e.ratio).toFixed(3)+"%","分红数量(DFS)":e.bonus.toFixed(8),"票数更新时间":e.voteTime}}));return t.push({"#":"汇总","投票人":S.totalVoters.toString(),"票数":(0,c.CE)(S.totalVotes.toFixed(0)),"投票占比":(100*S.totalRatio).toFixed(2)+"%","分红数量(DFS)":S.totalBonus.toFixed(0),"票数更新时间":""}),t},(r={}).fileName="".concat(S.node,"节点分红汇总"),r.datas=[{sheetData:t(v),sheetName:"投票数据",sheetFilter:["#","投票人","票数","投票占比","分红数量(DFS)","票数更新时间"],sheetHeader:["#","投票人","票数","投票占比","分红数量(DFS)","票数更新时间"]}],new(M())(r).saveExcel(),n.info(w),e.abrupt("return",!0);case 10:case"end":return e.stop()}}),e)}))),[v,S,S]),$=(0,j.useCallback)(s()(o()().mark((function e(){var t,r,s,l,d,m;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==v.length){e.next=2;break}return e.abrupt("return",!1);case 2:if(a&&a.broadcast){e.next=7;break}return n.error("".concat(q)),e.abrupt("return",!1);case 7:if(u){e.next=10;break}return n.error("".concat(z)),e.abrupt("return",!1);case 10:if(!((u.data.core_liquid_balance?u.data.core_liquid_balance.value:0)<S.totalBonus)){e.next=14;break}return n.error("".concat(B)),e.abrupt("return",!1);case 14:return t=[],v.forEach((function(e){var n=e.memo,r=e.voter,o=f.xR.from(Number(e.bonus),f.xR.Symbol.fromParts("DFS",8));t.push({account:"eosio.token",name:"transfer",authorization:[a.permissionLevel],data:{from:a.actor,to:r,quantity:o.toString(),memo:n}})})),r={actions:t},e.next=19,(0,c.zI)(a.transact(r));case 19:s=e.sent,l=i()(s,2),d=l[0],m=l[1],d?n.error(d):m&&m.response?n.success("".concat(A)):n.error("".concat(O));case 24:case"end":return e.stop()}}),e)}))),[v,a,S,u]),J=(0,j.useCallback)((function(){if(0===v.length)return!1;var e=[];v.forEach((function(t){var n=t.memo,r=t.voter,o=f.xR.from(Number(t.bonus),f.xR.Symbol.fromParts("DFS",8));e.push({contract:"eosio.token-DFS",to:r,amount:o.value,memo:n})}));var t=JSON.stringify(e,null,2),r="data:,".concat(t),o=document.createElement("a");o.href=r,o.download="".concat(S.node,"_bonus_transfer.json"),o.click(),n.info("".concat(Y))}),[v,S]),K=(0,j.useMemo)((function(){return[{title:"#",dataIndex:"key",key:"key",render:function(e,t,n){return(0,C.jsx)("span",{children:n+1})}},{title:"".concat(N),dataIndex:"voter",key:"voter",sorter:function(e,t){return e.voter.localeCompare(t.voter)},render:function(e,t){return(0,C.jsx)("span",{children:t.voter})}},{title:"".concat(Z),dataIndex:"vote",key:"vote",sorter:function(e,t){return e.vote-t.vote},render:function(e,t){return(0,C.jsx)("span",{children:t.vote})}},{title:"".concat(D),dataIndex:"ratio",key:"ratio",sorter:function(e,t){return e.ratio-t.ratio},render:function(e,t){return(0,C.jsxs)("span",{children:[(100*t.ratio).toFixed(3),"%"]})}},{title:"".concat(I),dataIndex:"bonus",key:"bonus",sorter:function(e,t){return e.bonus-t.bonus},render:function(e,t){return(0,C.jsx)("span",{children:t.bonus.toFixed(8)})}},{title:"".concat(R),dataIndex:"voteTime",key:"voteTime",sorter:function(e,t){return g().utc(e.voteTime).unix()-g().utc(t.voteTime).unix()},render:function(e,t){return(0,C.jsx)("span",{children:t.voteTime})}}]}),[]);return(0,C.jsxs)(l._z,{className:"nodebonus",ghost:!0,children:[(0,C.jsx)(d.Z,{className:"mb-3",scroll:{x:!0},size:"small",columns:K,dataSource:v,defaultData:[],search:!1,options:!1,pagination:!1,tableAlertRender:!1,tableAlertOptionRender:!1,headerTitle:(0,C.jsxs)(b.Z,{wrap:!0,className:"mb-[16px]",children:[(0,C.jsx)(x.ZP,{type:"primary",onClick:function(){return k.current.handleOpen()},children:E}),(0,C.jsx)(x.ZP,{type:"primary",onClick:function(){return $()},children:P}),(0,C.jsx)(x.ZP,{type:"primary",onClick:function(){return H()},children:V}),(0,C.jsx)(x.ZP,{type:"primary",onClick:function(){return J()},children:_})]}),summary:function(){return(0,C.jsxs)(h.Z.Summary.Row,{children:[(0,C.jsx)(h.Z.Summary.Cell,{index:0,children:(0,C.jsx)("span",{className:"font-bold",children:T})}),(0,C.jsx)(h.Z.Summary.Cell,{index:1,children:(0,C.jsx)("span",{className:"font-bold",children:S.totalVoters})}),(0,C.jsx)(h.Z.Summary.Cell,{index:2,children:(0,C.jsx)("span",{className:"font-bold",children:(0,c.CE)(S.totalVotes.toFixed(0))})}),(0,C.jsx)(h.Z.Summary.Cell,{index:3,children:(0,C.jsxs)("span",{className:"font-bold",children:[(100*S.totalRatio).toFixed(2),"%"]})}),(0,C.jsx)(h.Z.Summary.Cell,{index:4,children:(0,C.jsx)("span",{className:"font-bold",children:S.totalBonus.toFixed(0)})}),(0,C.jsx)(h.Z.Summary.Cell,{index:5})]})}}),(0,C.jsx)(F.default,{ref:k}),r]})}}}]);